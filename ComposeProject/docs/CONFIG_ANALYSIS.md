# é…ç½®æ–‡ä»¶åˆ†æ (Configuration Analysis)

æœ¬æ–‡æ¡£è¯¦ç»†è§£é‡Šé¡¹ç›®ä¸­æ‰€æœ‰é…ç½®æ–‡ä»¶çš„å†…å®¹å’Œé…ç½®æ–¹æ³•ã€‚

---

## ğŸ“„ é…ç½®æ–‡ä»¶æ¦‚è§ˆ

### 1. ä¸»é…ç½®æ–‡ä»¶ï¼š`config.py`

**ä½ç½®**: `ComposeProject/config.py`

**ä½œç”¨**: é¡¹ç›®çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å¯é…ç½®å‚æ•°ã€‚

**ä¿®æ”¹æ–¹æ³•**:
```bash
# ç›´æ¥ç¼–è¾‘æ–‡ä»¶
vim ComposeProject/config.py

# æˆ–ä½¿ç”¨ä»»ä½•æ–‡æœ¬ç¼–è¾‘å™¨
code ComposeProject/config.py
```

---

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### 2.1 å®éªŒé…ç½® (Experiment)

```python
"experiment": {
    "name": "default_adaptive_pinn",  # å®éªŒåç§°ï¼Œä¼šç”¨äºç»“æœæ–‡ä»¶å‘½å
}
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `name` | str | å®éªŒæ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒå®éªŒçš„ç»“æœæ–‡ä»¶ |

### 2.2 æ•°æ®é…ç½® (Data)

```python
"data": {
    "file_path": "../PINN/DATA.xlsx",     # æ•°æ®æ–‡ä»¶è·¯å¾„
    "sheet_name_template": "avg_1_z",    # Excelå·¥ä½œè¡¨å‘½åæ¨¡æ¿
    "use_columns": "B:EG",               # ä½¿ç”¨çš„åˆ—èŒƒå›´
    "z_size": 72,                        # Zå±‚æ•°é‡
    "y_size": 136,                       # Yæ–¹å‘å°ºå¯¸
    "space_dims": [20.0, 10.0, 10.0],   # ç‰©ç†ç©ºé—´å°ºå¯¸ [X, Y, Z] (ç±³)
    "num_samples": 300,                  # è®­ç»ƒé‡‡æ ·ç‚¹æ•°
    "downsample_factor": 1,              # é¢„æµ‹ç½‘æ ¼é™é‡‡æ ·ç³»æ•°
}
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `file_path` | str | Excelæ•°æ®æ–‡ä»¶è·¯å¾„ |
| `sheet_name_template` | str | å·¥ä½œè¡¨å‘½åæ¨¡å¼ï¼Œç”¨`z`è¡¨ç¤ºå±‚å· |
| `use_columns` | str | Excelåˆ—èŒƒå›´ï¼ˆå¦‚"B:EG"ï¼‰ |
| `z_size` | int | æ•°æ®ä¸­çš„Zå±‚æ€»æ•° |
| `y_size` | int | æ¯ä¸ªZå±‚çš„Yæ–¹å‘å°ºå¯¸ |
| `space_dims` | list | ç‰©ç†ä¸–ç•Œå°ºå¯¸ [X,Y,Z] ç±³ |
| `num_samples` | int | è®­ç»ƒæ•°æ®é‡‡æ ·ç‚¹æ•° |
| `downsample_factor` | int | é¢„æµ‹æ—¶ç½‘æ ¼åˆ†è¾¨ç‡é™ä½å€æ•° |

### 2.3 é‡‡æ ·é…ç½® (Sampling) â­æ–°å¢

```python
"sampling": {
    "strategy": "kriging_style",  # é‡‡æ ·ç­–ç•¥é€‰æ‹©
    "kriging_style": {
        "box_origin": [5, 5, 5],      # é‡‡æ ·åŒºåŸŸèµ·ç‚¹ [x, y, z] (ç½‘æ ¼ç´¢å¼•)
        "box_extent": [126, 126, 62], # é‡‡æ ·åŒºåŸŸå»¶ä¼¸é•¿åº¦ [x_len, y_len, z_len]
        "step_sizes": [5],            # é‡‡æ ·æ­¥é•¿åˆ—è¡¨
        "source_positions": [],       # æºç‚¹ä½ç½®åˆ—è¡¨ï¼Œç”¨äºæ’é™¤
        "source_exclusion_radius": 30.0,  # æºç‚¹æ’é™¤åŠå¾„
    },
    "random_sampling": {
        "num_samples": 300,           # éšæœºé‡‡æ ·ç‚¹æ•°
    }
}
```

#### é‡‡æ ·ç­–ç•¥è¯´æ˜

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `"kriging_style"` | Krigingé£æ ¼ç»“æ„åŒ–ç½‘æ ¼é‡‡æ · | ä¸»æ¨èï¼Œå‡ ä½•é‡‡æ ·ï¼Œä¸Krigingä¸€è‡´ |
| `"positive_only"` | ä»…æ­£å‰‚é‡åŒºåŸŸéšæœºé‡‡æ · | ç®€å•éšæœºé‡‡æ · |
| `"uniform"` | å…¨ç½‘æ ¼å‡åŒ€éšæœºé‡‡æ · | æµ‹è¯•ç”¨ |
| `"high_dose"` | é«˜å‰‚é‡åŒºåŸŸä¼˜å…ˆé‡‡æ · | é‡ç‚¹å…³æ³¨é«˜å‰‚é‡åŒº |
| `"gradient_based"` | æ¢¯åº¦åŒºåŸŸä¼˜å…ˆé‡‡æ · | å…³æ³¨å‰‚é‡å˜åŒ–è¾¹ç•Œ |

#### Krigingé£æ ¼é‡‡æ ·å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `box_origin` | list | é‡‡æ ·åŒºåŸŸèµ·ç‚¹åæ ‡ [x, y, z]ï¼ˆç½‘æ ¼ç´¢å¼•ï¼‰ |
| `box_extent` | list | é‡‡æ ·åŒºåŸŸåœ¨å„æ–¹å‘çš„å»¶ä¼¸é•¿åº¦ [x_len, y_len, z_len] |
| `step_sizes` | list | é‡‡æ ·æ­¥é•¿åˆ—è¡¨ï¼Œå¤šä¸ªæ­¥é•¿ä¼šäº§ç”Ÿå¤šå°ºåº¦é‡‡æ · |
| `source_positions` | list | æºç‚¹ä½ç½®åˆ—è¡¨ï¼Œæ¯ä¸ªæºç‚¹æ ¼å¼ [x, y, z] |
| `source_exclusion_radius` | float | æºç‚¹é™„è¿‘çš„æ’é™¤åŠå¾„ï¼Œé¿å…å¼‚å¸¸å€¼ |

### 2.4 PINNé…ç½® (PINN)

```python
"pinn": {
    "model_params": {
        "network_layers": [3, 64, 64, 64, 1],  # ç½‘ç»œç»“æ„
        "learning_rate": 1e-3,                  # å­¦ä¹ ç‡
        "loss_ratio": 10.0,                     # æ•°æ®æŸå¤±:ç‰©ç†æŸå¤± æƒé‡æ¯”
        "num_collocation_points": 4096,         # ç‰©ç†æ–¹ç¨‹æ±‚è§£ç‚¹æ•°
    },
    "training_params": {
        "total_epochs": 5000,    # æ€»è®­ç»ƒè½®æ•°
        "detect_every": 500,     # æ¯Nè½®æ£€æµ‹æ—©åœæ¡ä»¶
        "adaptive_cycle_epochs": 2000,  # è‡ªé€‚åº”å‘¨æœŸé•¿åº¦
    },
    "physical_params": {
        'rho': 1.2,              # ä»‹è´¨å¯†åº¦ (kg/mÂ³)
        'mu': 1e-3               # åŠ¨æ€ç²˜åº¦ (PaÂ·s)
    }
}
```

#### ç½‘ç»œç»“æ„å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `network_layers` | list | ç¥ç»ç½‘ç»œå„å±‚ç¥ç»å…ƒæ•°ï¼Œå¦‚ `[3, 64, 64, 64, 1]` è¡¨ç¤ºè¾“å…¥3ç»´ï¼Œ3ä¸ªéšè—å±‚å„64ä¸ªç¥ç»å…ƒï¼Œè¾“å‡º1ç»´ |
| `learning_rate` | float | Adamä¼˜åŒ–å™¨å­¦ä¹ ç‡ |
| `loss_ratio` | float | æ•°æ®æ‹ŸåˆæŸå¤± vs ç‰©ç†æ–¹ç¨‹æŸå¤±çš„æƒé‡æ¯”å€¼ |
| `num_collocation_points` | int | ç”¨äºç‰©ç†æ–¹ç¨‹æ±‚è§£çš„é…ç½®ç‚¹æ•°é‡ |

#### è®­ç»ƒå‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `total_epochs` | int | æœ€å¤§è®­ç»ƒè½®æ•° |
| `detect_every` | int | æ¯éš”å¤šå°‘è½®æ£€æµ‹æ€§èƒ½æ”¹å–„ï¼ˆæ—©åœæ¡ä»¶ï¼‰ |
| `adaptive_cycle_epochs` | int | è‡ªé€‚åº”è®­ç»ƒå‘¨æœŸé•¿åº¦ |

#### ç‰©ç†å‚æ•°

| å‚æ•° | ç±»å‹ | å•ä½ | è¯´æ˜ |
|------|------|------|------|
| `rho` | float | kg/mÂ³ | ä»‹è´¨å¯†åº¦ï¼ˆç©ºæ°”ä¸º1.2ï¼‰ |
| `mu` | float | PaÂ·s | åŠ¨æ€ç²˜åº¦ |

### 2.5 Krigingé…ç½® (Kriging)

```python
"kriging": {
    "variogram_model": "exponential",  # å˜å¼‚å‡½æ•°æ¨¡å‹
    "nlags": 8,                        # è·ç¦»åˆ†ç»„æ•°
    "block_size": 10000,               # GPUåˆ†å—å¤§å°
}
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `variogram_model` | str | å˜å¼‚å‡½æ•°æ¨¡å‹ï¼š`"linear"`, `"power"`, `"gaussian"`, `"spherical"`, `"exponential"` |
| `nlags` | int | è·ç¦»åˆ†ç»„æ•°é‡ï¼Œç”¨äºè®¡ç®—å˜å¼‚å‡½æ•° |
| `block_size` | int | GPUåˆ†å—å¤„ç†å¤§å°ï¼Œå½±å“å†…å­˜ä½¿ç”¨ |

### 2.6 æ–¹æ³•é€‰æ‹©é…ç½® (Selection)

```python
"selection": {
    "min_points_for_kriging": 100,     # Krigingæœ€å°‘éœ€è¦çš„ç‚¹æ•°
    "uniformity_cv_threshold": 0.6,    # å‡åŒ€æ€§é˜ˆå€¼ï¼ˆCVå€¼ï¼‰
}
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `min_points_for_kriging` | int | æ•°æ®ç‚¹å°‘äºæ­¤å€¼æ—¶å¼ºåˆ¶é€‰æ‹©PINN |
| `uniformity_cv_threshold` | float | æ•°æ®åˆ†å¸ƒå‡åŒ€æ€§é˜ˆå€¼ï¼Œä½äºæ­¤å€¼é€‰æ‹©Kriging |

### 2.7 ç³»ç»Ÿé…ç½® (System)

```python
"system": {
    "use_gpu": True,                    # æ˜¯å¦ä½¿ç”¨GPU
    "random_seed": 42,                  # éšæœºç§å­
    "verbose": True,                    # è¯¦ç»†è¾“å‡º
    "save_results": True,               # ä¿å­˜ç»“æœ
    "checkpoint_path": "./models/pinn_checkpoint"  # æ£€æŸ¥ç‚¹è·¯å¾„
}
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `use_gpu` | bool | æ˜¯å¦ä½¿ç”¨GPUåŠ é€Ÿï¼ˆéœ€è¦CuPyå’ŒPyTorchï¼‰ |
| `random_seed` | int | éšæœºç§å­ï¼Œä¿è¯ç»“æœå¯é‡ç° |
| `verbose` | bool | æ˜¯å¦æ‰“å°è¯¦ç»†è¿è¡Œä¿¡æ¯ |
| `save_results` | bool | æ˜¯å¦ä¿å­˜è®­ç»ƒç»“æœå’Œå›¾åƒ |
| `checkpoint_path` | str | æ¨¡å‹æ£€æŸ¥ç‚¹ä¿å­˜è·¯å¾„ |

---

## ğŸ›ï¸ é¢„è®¾é…ç½® (PRESETS)

é¡¹ç›®æä¾›äº†å¤šä¸ªé¢„è®¾é…ç½®ï¼Œå¯ä»¥é€šè¿‡ `--preset` å‚æ•°é€‰æ‹©ï¼š

### 3.1 å¯ç”¨é¢„è®¾

| é¢„è®¾åç§° | ç”¨é€” | ç‰¹ç‚¹ |
|----------|------|------|
| `"default"` | é»˜è®¤é…ç½® | å¹³è¡¡çš„æ€§èƒ½å’Œå‡†ç¡®æ€§ |
| `"quick_test"` | å¿«é€Ÿæµ‹è¯• | å‡å°‘é‡‡æ ·ç‚¹å’Œè®­ç»ƒè½®æ•° |
| `"kriging_only"` | å¼ºåˆ¶Kriging | æ— è®ºæ•°æ®åˆ†å¸ƒéƒ½ä½¿ç”¨Kriging |
| `"pinn_only"` | å¼ºåˆ¶PINN | æ— è®ºæ•°æ®åˆ†å¸ƒéƒ½ä½¿ç”¨PINN |
| `"random_sampling"` | éšæœºé‡‡æ · | ä½¿ç”¨ä¼ ç»Ÿçš„éšæœºé‡‡æ ·ç­–ç•¥ |

### 3.2 è‡ªå®šä¹‰é¢„è®¾

åœ¨ `PRESETS` å­—å…¸ä¸­æ·»åŠ æ–°é¢„è®¾ï¼š

```python
PRESETS["my_custom"] = {
    **DEFAULT_CONFIG,  # åŸºäºé»˜è®¤é…ç½®
    "experiment": {"name": "my_experiment"},
    "sampling": {
        "strategy": "kriging_style",
        "kriging_style": {
            "box_origin": [0, 0, 0],     # ä»åŸç‚¹å¼€å§‹é‡‡æ ·
            "box_extent": [100, 100, 50], # æ›´å¤§çš„é‡‡æ ·åŒºåŸŸ
            "step_sizes": [3],           # æ›´å¯†çš„é‡‡æ ·æ­¥é•¿
            "source_positions": [[50, 50, 5]],  # æŒ‡å®šæºç‚¹ä½ç½®
            "source_exclusion_radius": 10.0,    # æºç‚¹æ’é™¤åŠå¾„
        }
    },
    "pinn": {
        **DEFAULT_CONFIG["pinn"],
        "training_params": {"total_epochs": 8000}  # æ›´é•¿çš„è®­ç»ƒ
    }
}
```

ç„¶åä½¿ç”¨ï¼š
```bash
python main.py --preset my_custom
```

---

## ğŸ”§ é…ç½®ä¿®æ”¹ç¤ºä¾‹

### 4.1 ä¿®æ”¹é‡‡æ ·åŒºåŸŸ

```python
# åœ¨config.pyä¸­ä¿®æ”¹samplingéƒ¨åˆ†
"sampling": {
    "strategy": "kriging_style",
    "kriging_style": {
        "box_origin": [10, 10, 10],     # ä»(10,10,10)å¼€å§‹é‡‡æ ·
        "box_extent": [80, 80, 40],     # é‡‡æ ·èŒƒå›´80Ã—80Ã—40
        "step_sizes": [5],              # æ¯5ä¸ªç½‘æ ¼ç‚¹é‡‡æ ·ä¸€æ¬¡
        "source_positions": [[50, 50, 25]],  # æºç‚¹ä½ç½®
        "source_exclusion_radius": 20.0,     # æ’é™¤æºç‚¹é™„è¿‘20å•ä½
    }
}
```

### 4.2 è°ƒæ•´PINNè®­ç»ƒ

```python
"pinn": {
    "model_params": {
        "network_layers": [3, 128, 128, 128, 1],  # æ›´å¤§çš„ç½‘ç»œ
        "learning_rate": 5e-4,                    # æ›´å°çš„å­¦ä¹ ç‡
        "loss_ratio": 5.0,                        # é™ä½ç‰©ç†æŸå¤±æƒé‡
        "num_collocation_points": 8192,           # æ›´å¤šé…ç½®ç‚¹
    },
    "training_params": {
        "total_epochs": 10000,    # æ›´é•¿çš„è®­ç»ƒ
        "detect_every": 200,      # æ›´é¢‘ç¹çš„æ£€æµ‹
    }
}
```

### 4.3 å¯ç”¨æºç‚¹æ’é™¤

```python
"sampling": {
    "strategy": "kriging_style",
    "kriging_style": {
        "source_positions": [
            [48, 45, 5],   # æ¡¶æº
            [97, 90, 54]   # å¢™å£æº
        ],
        "source_exclusion_radius": 30.0,  # æ’é™¤æºç‚¹é™„è¿‘30å•ä½
    }
}
```

---

## ğŸ“Š é…ç½®éªŒè¯

è¿è¡Œç¨‹åºæ—¶ä¼šè‡ªåŠ¨éªŒè¯é…ç½®ï¼š

```bash
# åŸºæœ¬è¿è¡Œ
python main.py

# ä½¿ç”¨ç‰¹å®šé¢„è®¾
python main.py --preset quick_test

# è¯¦ç»†è¾“å‡ºé…ç½®ä¿¡æ¯
python main.py --verbose
```

### å¸¸è§é…ç½®é”™è¯¯

1. **é‡‡æ ·åŒºåŸŸè¶…å‡ºæ•°æ®è¾¹ç•Œ**
   ```
   é”™è¯¯: box_extent å¤ªå¤§ï¼Œè¶…è¿‡äº†æ•°æ®ç½‘æ ¼å°ºå¯¸
   è§£å†³: æ£€æŸ¥æ•°æ®ç½‘æ ¼å½¢çŠ¶ï¼Œè°ƒæ•´ box_extent
   ```

2. **æºç‚¹æ’é™¤åŠå¾„è¿‡å¤§**
   ```
   é”™è¯¯: æ’é™¤äº†å¤ªå¤šæœ‰æ•ˆç‚¹
   è§£å†³: å‡å° source_exclusion_radius æˆ–è°ƒæ•´æºç‚¹ä½ç½®
   ```

3. **ç½‘ç»œå±‚æ•°è®¾ç½®ä¸åˆç†**
   ```
   é”™è¯¯: è¾“å…¥è¾“å‡ºç»´åº¦ä¸åŒ¹é…
   è§£å†³: ç¡®ä¿ç¬¬ä¸€å±‚ä¸º3ï¼Œæœ€åä¸€å±‚ä¸º1
   ```

---

## ğŸ’¡ é…ç½®æœ€ä½³å®è·µ

### 6.1 æ–°æ‰‹æ¨èé…ç½®

```python
# ä½¿ç”¨å¿«é€Ÿæµ‹è¯•é¢„è®¾å¼€å§‹
python main.py --preset quick_test

# éªŒè¯ç¯å¢ƒæ­£å¸¸åä½¿ç”¨é»˜è®¤é…ç½®
python main.py --preset default
```

### 6.2 æ€§èƒ½è°ƒä¼˜

1. **åŠ é€Ÿè®­ç»ƒ**ï¼šå‡å°‘ `num_collocation_points` å’Œ `total_epochs`
2. **æé«˜å‡†ç¡®æ€§**ï¼šå¢åŠ  `network_layers` ç¥ç»å…ƒæ•°
3. **èŠ‚çœå†…å­˜**ï¼šå‡å° `block_size`ï¼ˆKrigingåˆ†å—å¤§å°ï¼‰
4. **é¿å…è¿‡æ‹Ÿåˆ**ï¼šè°ƒæ•´ `loss_ratio`ï¼Œå¹³è¡¡æ•°æ®æŸå¤±å’Œç‰©ç†æŸå¤±

### 6.3 ä¸åŒåº”ç”¨åœºæ™¯é…ç½®

#### é«˜ç²¾åº¦ç‰©ç†æ¨¡æ‹Ÿ
```python
"pinn": {
    "loss_ratio": 1.0,           # æé«˜ç‰©ç†çº¦æŸæƒé‡
    "num_collocation_points": 16384,  # æ›´å¤šç‰©ç†ç‚¹
    "network_layers": [3, 256, 256, 256, 1]  # æ›´å¤§ç½‘ç»œ
}
```

#### å¿«é€ŸåŸå‹éªŒè¯
```python
"sampling": {"strategy": "positive_only"},
"pinn": {
    "num_collocation_points": 1024,  # å‡å°‘ç‰©ç†ç‚¹
    "training_params": {"total_epochs": 1000}  # å‡å°‘è®­ç»ƒè½®æ•°
}
```

#### æ•°æ®å¯†é›†åŒºåŸŸåˆ†æ
```python
"sampling": {
    "strategy": "high_dose",     # é‡ç‚¹é‡‡æ ·é«˜å‰‚é‡åŒº
    "random_sampling": {"num_samples": 500}  # æ›´å¤šé‡‡æ ·ç‚¹
}
```

---

*æœ€åæ›´æ–°: 2024å¹´*
