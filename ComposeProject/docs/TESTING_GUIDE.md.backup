# æµ‹è¯•äººå‘˜æŒ‡å— (Testing Guide)

æœ¬æ–‡æ¡£æŒ‡å¯¼æµ‹è¯•äººå‘˜å¦‚ä½•å•ç‹¬è¿è¡Œ PINN å’Œ Kriging ç®—æ³•ï¼Œä»¥åŠå¦‚ä½•è¿›è¡Œå¯¹æ¯”æµ‹è¯•ã€‚

---

## ä¸€ã€é¡¹ç›®æ–‡ä»¶ç»“æ„

```
è€¦åˆé¡¹ç›®V2/
â”œâ”€â”€ ComposeProject/           # è€¦åˆç³»ç»Ÿä¸»ç›®å½•
â”‚   â”œâ”€â”€ main.py              # è€¦åˆç³»ç»Ÿå…¥å£
â”‚   â”œâ”€â”€ config.py            # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ src/                 # æºä»£ç æ¨¡å—
â”œâ”€â”€ PINN/                     # PINNç®—æ³•æ¨¡å—
â”‚   â”œâ”€â”€ pinn_core.py         # PINNæ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ data_processing.py   # æ•°æ®å¤„ç†å·¥å…·
â”‚   â”œâ”€â”€ PINNTest.ipynb       # â­ PINNç‹¬ç«‹æµ‹è¯•å…¥å£
â”‚   â””â”€â”€ DATA.xlsx            # é»˜è®¤æ•°æ®æ–‡ä»¶
â”œâ”€â”€ Kriging/                  # Krigingç®—æ³•æ¨¡å—
â”‚   â”œâ”€â”€ myKriging.py         # Krigingä¸»æ¥å£
â”‚   â”œâ”€â”€ myPyKriging3D.py     # GPUåŠ é€Ÿå®ç°
â”‚   â”œâ”€â”€ main.ipynb           # â­ Krigingç‹¬ç«‹æµ‹è¯•å…¥å£
â”‚   â””â”€â”€ test.ipynb           # è¯¦ç»†æµ‹è¯•ç”¨ä¾‹
â””â”€â”€ compare_data.py          # â­ æ•°æ®æµç¨‹å¯¹æ¯”å·¥å…·
```

---

## äºŒã€å•ç‹¬è¿è¡Œ PINN ç®—æ³•

### 2.1 å…¥å£æ–‡ä»¶

**æ¨èå…¥å£**: `PINN/PINNTest.ipynb`ï¼ˆJupyter Notebookï¼‰

**Pythonå…¥å£**: å¯ç›´æ¥å¯¼å…¥ `pinn_core.py` ä¸­çš„ `PINNTrainer` ç±»

### 2.2 åŸºæœ¬ä½¿ç”¨æµç¨‹

```python
import sys
sys.path.insert(0, 'PINN')

from pinn_core import PINNTrainer, SimulationConfig
from data_processing import RadiationDataProcessor, DataLoader
import numpy as np
import pandas as pd

# 1. åŠ è½½æ•°æ®
excel_data = pd.read_excel('PINN/DATA.xlsx', sheet_name=None)
if 'Sheet1' in excel_data:
    del excel_data['Sheet1']
raw_data_dict = {int(k.split('_')[-1]): v for k, v in excel_data.items()}

# 2. å¤„ç†æ•°æ®
processor = RadiationDataProcessor()
dose_data = processor.load_from_dict(raw_data_dict, space_dims=[20.0, 10.0, 10.0])

# 3. é‡‡æ ·è®­ç»ƒç‚¹
train_points, train_values, train_log_values = DataLoader.sample_training_points(
    dose_data, 
    num_samples=300,
    sampling_strategy='positive_only'  # å¯é€‰ç­–ç•¥
)

# 4. åˆ›å»ºå¹¶è®­ç»ƒPINN
physical_params = {
    'rho_material': 1.205,        # ç©ºæ°”å¯†åº¦ kg/mÂ³
    'mass_energy_abs_coeff': 1.0  # è´¨èƒ½å¸æ”¶ç³»æ•°
}

trainer = PINNTrainer(physical_params=physical_params)
trainer.create_pinn_model(
    dose_data=dose_data,
    sampled_points_xyz=train_points,
    sampled_log_doses_values=train_log_values,
    include_source=False,
    network_config={'layers': [3, 64, 64, 64, 1], 'activation': 'tanh'}
)

# 5. è®­ç»ƒ
trainer.train(epochs=5000, use_lbfgs=True, loss_weights=[1, 100])

# 6. é¢„æµ‹
predictions = trainer.predict(prediction_points)
```

### 2.3 å…³é”®ç±»å’Œæ–¹æ³•

| ç±»/æ–¹æ³• | æ–‡ä»¶ | è¯´æ˜ |
|--------|------|------|
| `PINNTrainer` | `pinn_core.py` | PINNè®­ç»ƒå™¨ä¸»ç±» |
| `SimulationConfig` | `pinn_core.py` | æ¨¡æ‹Ÿå‚æ•°é…ç½® |
| `RadiationDataProcessor` | `data_processing.py` | æ•°æ®å¤„ç†å™¨ |
| `DataLoader.sample_training_points()` | `data_processing.py` | è®­ç»ƒç‚¹é‡‡æ · |

---

## ä¸‰ã€å•ç‹¬è¿è¡Œ Kriging ç®—æ³•

### 3.1 å…¥å£æ–‡ä»¶

**æ¨èå…¥å£**: `Kriging/main.ipynb`ï¼ˆJupyter Notebookï¼‰

**è¯¦ç»†æµ‹è¯•**: `Kriging/test.ipynb`ï¼ˆåŒ…å«æ€§èƒ½æµ‹è¯•ï¼‰

### 3.2 åŸºæœ¬ä½¿ç”¨æµç¨‹

```python
import sys
sys.path.insert(0, 'Kriging')

from myKriging import training, testing
import pandas as pd
import numpy as np

# 1. å‡†å¤‡è®­ç»ƒæ•°æ®ï¼ˆDataFrameæ ¼å¼ï¼‰
# å¿…é¡»åŒ…å« 'x', 'y', 'z', 'target' å››åˆ—
train_df = pd.DataFrame({
    'x': train_points[:, 0],
    'y': train_points[:, 1],
    'z': train_points[:, 2],
    'target': train_values
})

# 2. è®­ç»ƒKrigingæ¨¡å‹
model = training(
    df=train_df,
    variogram_model="exponential",  # å¯é€‰: linear, power, gaussian, spherical, exponential
    nlags=8,                        # è·ç¦»åˆ†ç»„æ•°
    enable_plotting=False,          # æ˜¯å¦ç»˜åˆ¶å˜å¼‚å‡½æ•°å›¾
    weight=False,                   # æ˜¯å¦ä½¿ç”¨åŠ æƒ
    uk=False,                       # False=æ™®é€šKriging, True=æ³›å…‹é‡Œé‡‘
    cpu_on=False                    # False=ä½¿ç”¨GPU, True=ä½¿ç”¨CPU
)

# 3. é¢„æµ‹
test_df = pd.DataFrame({
    'x': prediction_points[:, 0],
    'y': prediction_points[:, 1],
    'z': prediction_points[:, 2],
    'target': np.zeros(len(prediction_points))  # è™šæ‹Ÿå€¼
})

predictions, actual_values = testing(
    df=test_df,
    model=model,
    block_size=10000,        # GPUåˆ†å—å¤§å°
    cpu_on=False,            # False=ä½¿ç”¨GPU
    style="gpu_b",           # æ‰§è¡Œé£æ ¼
    compute_precision=True   # æ˜¯å¦è®¡ç®—ç²¾åº¦
)
```

### 3.3 å…³é”®å‡½æ•°

| å‡½æ•° | æ–‡ä»¶ | è¯´æ˜ |
|-----|------|------|
| `training()` | `myKriging.py` | è®­ç»ƒKrigingæ¨¡å‹ |
| `testing()` | `myKriging.py` | ä½¿ç”¨æ¨¡å‹é¢„æµ‹å¹¶è®¡ç®—ç²¾åº¦ |
| `testing_for_time()` | `myKriging.py` | æ€§èƒ½è®¡æ—¶æµ‹è¯• |

### 3.4 å˜å¼‚å‡½æ•°æ¨¡å‹é€‰é¡¹

| æ¨¡å‹åç§° | é€‚ç”¨åœºæ™¯ |
|---------|---------|
| `linear` | çº¿æ€§å˜åŒ–çš„ç©ºé—´ç›¸å…³æ€§ |
| `power` | å¹‚å‡½æ•°å…³ç³» |
| `gaussian` | é«˜æ–¯å‹ï¼ˆå¹³æ»‘ï¼‰|
| `spherical` | çƒå‹ï¼ˆå¸¸ç”¨ï¼‰|
| `exponential` | æŒ‡æ•°å‹ï¼ˆæ¨èé»˜è®¤ï¼‰|

---

## å››ã€æ•°æ®è¾“å…¥é…ç½®

### 4.1 è¾“å…¥æ•°æ®æ ¼å¼

**é»˜è®¤æ•°æ®**: `PINN/DATA.xlsx`

**Excelç»“æ„**:
- å¤šä¸ªSheetï¼Œæ¯ä¸ªSheetä»£è¡¨ä¸€ä¸ªZå±‚
- Sheetå‘½å: `avg_1_1`, `avg_1_2`, ... `avg_1_N`
- æ¯ä¸ªSheet: Yè¡Œ Ã— Xåˆ—çš„å‰‚é‡å€¼çŸ©é˜µ

### 4.2 ä»ExcelåŠ è½½3Dæ•°æ®

```python
from ComposeProject.src.data.loader import load_3d_data_from_sheets, process_grid_to_dose_data

# åŠ è½½3Dæ•°æ®ç½‘æ ¼
dose_grid = load_3d_data_from_sheets(
    file_path="PINN/DATA.xlsx",
    sheet_name_template="avg_1_z",  # zä¼šè¢«æ›¿æ¢ä¸ºå®é™…å±‚å·
    use_cols="B:EG",                # ä½¿ç”¨çš„åˆ—èŒƒå›´
    z_size=72,                      # Zå±‚æ•°é‡
    y_size=136                      # Yæ–¹å‘å¤§å°
)

# è½¬æ¢ä¸ºdose_dataæ ¼å¼
dose_data = process_grid_to_dose_data(
    dose_grid=dose_grid,
    space_dims=[20.0, 10.0, 10.0]   # ç‰©ç†ç©ºé—´å°ºå¯¸ [X, Y, Z] ç±³
)
```

---

## äº”ã€é‡‡æ ·ç­–ç•¥

### 5.1 æ”¯æŒçš„é‡‡æ ·ç­–ç•¥

é¡¹ç›®æ”¯æŒå¤šç§é‡‡æ ·ç­–ç•¥ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š

#### 5.1.1 Krigingé£æ ¼ç»“æ„åŒ–é‡‡æ · â­æ¨è

**ç­–ç•¥åç§°**: `kriging_style`ï¼ˆåœ¨ `ComposeProject/src/data/unified_sampling.py` ä¸­å®ç°ï¼‰

è¿™æ˜¯**æ¨èçš„ä¸»è¦é‡‡æ ·ç­–ç•¥**ï¼Œä¸ Kriging/dataAnalysis.py ä¸­çš„ç»“æ„åŒ–ç½‘æ ¼é‡‡æ ·å®Œå…¨ä¸€è‡´ã€‚

**æ ¸å¿ƒç‰¹æ€§**:
- å‡ ä½•ç»“æ„åŒ–é‡‡æ ·ï¼ˆç½‘æ ¼æ­¥è¿›ï¼‰
- å¯ç²¾ç¡®æ§åˆ¶é‡‡æ ·åŒºåŸŸå’Œå¯†åº¦
- æ”¯æŒæºç‚¹æ’é™¤
- ç¡®å®šæ€§é‡‡æ ·ï¼ˆç›¸åŒå‚æ•°=ç›¸åŒç»“æœï¼‰

**ä½¿ç”¨æ–¹æ³•**:
```python
from ComposeProject.src.data.loader import sample_kriging_style

# åœ¨ ComposeProject ä¸­ä½¿ç”¨
train_points, train_values = sample_kriging_style(
    dose_data,
    box_origin=[5, 5, 5],      # é‡‡æ ·åŒºåŸŸèµ·ç‚¹ [x, y, z] (ç½‘æ ¼ç´¢å¼•)
    box_extent=[90, 90, 60],   # é‡‡æ ·åŒºåŸŸå»¶ä¼¸é•¿åº¦ [x_len, y_len, z_len]
    step_sizes=[5],            # é‡‡æ ·æ­¥é•¿åˆ—è¡¨
    source_positions=[],       # æºç‚¹ä½ç½®åˆ—è¡¨ï¼Œç”¨äºæ’é™¤
    source_exclusion_radius=30.0  # æºç‚¹æ’é™¤åŠå¾„
)
```

**é…ç½®å‚æ•°è¯¦è§£**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `box_origin` | list | é‡‡æ ·åŒºåŸŸèµ·ç‚¹åæ ‡ [x, y, z]ï¼ˆç½‘æ ¼ç´¢å¼•ï¼‰ |
| `box_extent` | list | é‡‡æ ·åŒºåŸŸåœ¨å„æ–¹å‘çš„å»¶ä¼¸é•¿åº¦ [x_len, y_len, z_len] |
| `step_sizes` | list | é‡‡æ ·æ­¥é•¿åˆ—è¡¨ï¼Œå¤šä¸ªæ­¥é•¿ä¼šäº§ç”Ÿå¤šå°ºåº¦é‡‡æ · |
| `source_positions` | list | æºç‚¹ä½ç½®åˆ—è¡¨ï¼Œæ¯ä¸ªæºç‚¹æ ¼å¼ [x, y, z] |
| `source_exclusion_radius` | float | æºç‚¹é™„è¿‘çš„æ’é™¤åŠå¾„ |

#### 5.1.2 éšæœºé‡‡æ ·ç­–ç•¥

`DataLoader.sample_training_points()` æ”¯æŒä»¥ä¸‹éšæœºé‡‡æ ·ç­–ç•¥ï¼š

| ç­–ç•¥åç§° | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| `positive_only` | ä»…ä»æ­£å‰‚é‡åŒºåŸŸéšæœºé‡‡æ · | ç®€å•éšæœºé‡‡æ ·ï¼Œå‘åå…¼å®¹ |
| `positive_weighted` | æŒ‰å‰‚é‡å€¼åŠ æƒé‡‡æ · | é«˜å‰‚é‡åŒºåŸŸæ›´é‡è¦æ—¶ |
| `uniform` | å…¨ç½‘æ ¼å‡åŒ€éšæœºé‡‡æ · | æµ‹è¯•ç”¨é€” |
| `high_dose` | ä¼˜å…ˆé‡‡æ ·é«˜å‰‚é‡åŒºåŸŸ | å…³æ³¨å³°å€¼åŒºåŸŸ |
| `gradient_based` | åŸºäºæ¢¯åº¦é‡‡æ · | è¾¹ç•ŒåŒºåŸŸæ›´é‡è¦æ—¶ |
| `focused_random` | èšç„¦åŒºåŸŸéšæœºé‡‡æ · | ç‰¹å®šåŒºåŸŸé‡ç‚¹é‡‡æ · |

### 5.2 é‡‡æ ·ç­–ç•¥å¯¹æ¯”

| ç‰¹æ€§ | Krigingé£æ ¼ | éšæœºé‡‡æ · |
|------|------------|----------|
| **å¯é‡å¤æ€§** | âœ… ç¡®å®šæ€§ | âš ï¸ ä¾èµ–éšæœºç§å­ |
| **ç©ºé—´æ§åˆ¶** | âœ… ç²¾ç¡®å‡ ä½•æ§åˆ¶ | âŒ éšæœºåˆ†å¸ƒ |
| **æºç‚¹å¤„ç†** | âœ… å¯æ’é™¤æºç‚¹ | âŒ æ— ç‰¹æ®Šå¤„ç† |
| **å¯†åº¦æ§åˆ¶** | âœ… æ­¥é•¿æ§åˆ¶ | âŒ éš¾ä»¥ç²¾ç¡®æ§åˆ¶ |
| **ä¸Krigingä¸€è‡´æ€§** | âœ… å®Œå…¨ä¸€è‡´ | âŒ ä¸ä¸€è‡´ |

### 5.3 ä½¿ç”¨ç¤ºä¾‹

#### Krigingé£æ ¼é‡‡æ ·ï¼ˆæ¨èï¼‰
```python
from ComposeProject.src.data.loader import sample_kriging_style

# åŸºæœ¬ä½¿ç”¨
train_points, train_values = sample_kriging_style(
    dose_data,
    box_origin=[5, 5, 5],
    box_extent=[90, 90, 60],
    step_sizes=[5]
)

# å¸¦æºç‚¹æ’é™¤
train_points, train_values = sample_kriging_style(
    dose_data,
    box_origin=[5, 5, 5],
    box_extent=[90, 90, 60],
    step_sizes=[5],
    source_positions=[[48, 45, 5], [97, 90, 54]],  # æºç‚¹ä½ç½®
    source_exclusion_radius=30.0
)
```

#### éšæœºé‡‡æ ·ç­–ç•¥
```python
from PINN.data_processing import DataLoader

# æ­£å‰‚é‡åŒºåŸŸéšæœºé‡‡æ ·ï¼ˆå‘åå…¼å®¹ï¼‰
train_points, train_values, _ = DataLoader.sample_training_points(
    dose_data, 
    num_samples=300,
    sampling_strategy='positive_only'
)

# é«˜å‰‚é‡ä¼˜å…ˆé‡‡æ ·
train_points, train_values, _ = DataLoader.sample_training_points(
    dose_data, 
    num_samples=300,
    sampling_strategy='high_dose'
)

# å‡åŒ€éšæœºé‡‡æ ·
train_points, train_values, _ = DataLoader.sample_training_points(
    dose_data, 
    num_samples=300,
    sampling_strategy='uniform'
)
```

### 5.4 é…ç½®æ–¹å¼é‡‡æ ·

é€šè¿‡é…ç½®æ–‡ä»¶ä½¿ç”¨é‡‡æ ·ç­–ç•¥ï¼š

```python
# åœ¨ config.py ä¸­é…ç½®
"sampling": {
    "strategy": "kriging_style",  # æˆ–å…¶ä»–ç­–ç•¥
    "kriging_style": {
        "box_origin": [5, 5, 5],
        "box_extent": [126, 126, 62],
        "step_sizes": [5],
        "source_positions": [],
        "source_exclusion_radius": 30.0,
    },
    "random_sampling": {
        "num_samples": 300,
    }
}
```

ç„¶åè¿è¡Œï¼š
```bash
python main.py --preset default  # ä½¿ç”¨kriging_styleé‡‡æ ·
python main.py --preset random_sampling  # ä½¿ç”¨éšæœºé‡‡æ ·
```

---

## å…­ã€å¯¹æ¯”æµ‹è¯•æ–¹æ³•

### 6.1 å·²å®ç°çš„å¯¹æ¯”æµ‹è¯•æ–‡ä»¶

é¡¹ç›®æä¾›äº†ä¸“é—¨çš„å¯¹æ¯”æµ‹è¯•æ–‡ä»¶ï¼š`compare_sampling_methods.py`

**ä½ç½®**: `ComposeProject/compare_sampling_methods.py`

**åŠŸèƒ½**: å¯¹æ¯”ä¸‰ç§é‡‡æ ·æ–¹å¼çš„ä¸€è‡´æ€§
1. KrigingåŸç”Ÿé‡‡æ ·æ–¹å¼ï¼ˆ`Kriging/dataAnalysis.py`ï¼‰
2. ç»Ÿä¸€é‡‡æ ·æ¨¡å—ï¼ˆ`ComposeProject/src/data/unified_sampling.py`ï¼‰
3. PINN Krigingé£æ ¼é‡‡æ ·ï¼ˆ`PINN/data_processing.py`ï¼‰

### 6.2 è¿è¡Œå¯¹æ¯”æµ‹è¯•

```bash
cd ComposeProject
python compare_sampling_methods.py
```

### 6.3 æµ‹è¯•ç»“æœ

**æœ€æ–°æµ‹è¯•ç»“æœ**ï¼ˆ2024å¹´12æœˆè¿è¡Œï¼‰ï¼š

```
================================================================================
                                    é‡‡æ ·æ–¹å¼å¯¹æ¯”æµ‹è¯•                                    
================================================================================

--- [æ­¥éª¤ 1: åŠ è½½æ•°æ®] ---
æ•°æ®æ–‡ä»¶: /home/linghuankong/Projects/PythonProjects/è€¦åˆé¡¹ç›®V2/PINN/DATA.xlsx
âœ… Krigingæ ¼å¼æ•°æ®åŠ è½½æˆåŠŸï¼Œå…± 72 ä¸ªZå±‚
Loading radiation data from dictionary format...
Found 72 z-layers: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72]
Detected pandas DataFrame format
Data dimensions: X=137, Y=111, Z=72
Using default world bounds: [-10.  -5.  -5.] to [10.  5.  5.]
Data statistics:
  - Total voxels: 1,094,904
  - Non-zero voxels: 1,094,904 (100.00%)
  - Value range: 1.00e+00 to 1.57e+06
  - Voxel size: [0.1459854  0.09009009 0.13888889]
âœ… PINNæ ¼å¼æ•°æ®åŠ è½½æˆåŠŸï¼Œç½‘æ ¼å½¢çŠ¶: [137 111  72]

--- [æ­¥éª¤ 2: è®¾ç½®é‡‡æ ·å‚æ•°] ---
é‡‡æ ·å‚æ•°: {'box_origin': [5, 5, 5], 'box_extent': [90, 90, 60], 'step_sizes': [5], 'x_y_reverse': True, 'direction': '3vector'}
æ•°æ®ç½‘æ ¼å½¢çŠ¶: [137 111  72]

--- [æ–¹æ³• 1: Kriging/dataAnalysis.py åŸç”Ÿé‡‡æ ·] ---
âœ… KrigingåŸç”Ÿé‡‡æ ·å®Œæˆ: 4693 ä¸ªç‚¹
   åæ ‡èŒƒå›´: X=[5, 95], Y=[5, 95], Z=[5, 65]

--- [æ–¹æ³• 2: ComposeProject/src/data/unified_sampling.py é‡‡æ ·] ---
INFO: (UnifiedSampler) é‡‡æ ·å®Œæˆï¼Œå…± 4693 ä¸ªè®­ç»ƒç‚¹
âœ… ç»Ÿä¸€é‡‡æ ·æ¨¡å—å®Œæˆ: 4693 ä¸ªç‚¹
   åæ ‡èŒƒå›´: X=[5, 95], Y=[5, 95], Z=[5, 65]

--- [æ–¹æ³• 3: PINN/data_processing.py Krigingé£æ ¼é‡‡æ ·] ---
Krigingé£æ ¼é‡‡æ ·å®Œæˆ: 4693 ä¸ªè®­ç»ƒç‚¹
é‡‡æ ·åŒºåŸŸ: origin=[5, 5, 5], extent=[90, 90, 60], steps=[5]
å‰‚é‡èŒƒå›´: 4.08e+01 to 4.15e+04
âœ… PINN Krigingé£æ ¼é‡‡æ ·å®Œæˆ: 4693 ä¸ªç‚¹
   ç‰©ç†åæ ‡èŒƒå›´: X=[-9.20, 3.94], Y=[-4.50, 3.60], Z=[-4.24, 4.10]

================================================================================
===================================== å¯¹æ¯”ç»“æœ =====================================
================================================================================

--- é‡‡æ ·ç‚¹æ•°é‡å¯¹æ¯” ---
  KrigingåŸç”Ÿ: 4693 ä¸ªç‚¹
  ç»Ÿä¸€é‡‡æ ·: 4693 ä¸ªç‚¹
  PINN Krigingé£æ ¼: 4693 ä¸ªç‚¹
  âœ… æ‰€æœ‰æ–¹æ³•é‡‡æ ·ç‚¹æ•°é‡ä¸€è‡´ï¼

--- KrigingåŸç”Ÿ vs ç»Ÿä¸€é‡‡æ · åæ ‡å¯¹æ¯” ---
  âŒ å€¼ä¸ä¸€è‡´

--- å‰5ä¸ªé‡‡æ ·ç‚¹ç¤ºä¾‹ ---

KrigingåŸç”Ÿ (ç½‘æ ¼ç´¢å¼•):
   x  y   z    target
0  5  5   5  45.56526
1  5  5  10  46.43686
2  5  5  15  48.00318
3  5  5  20  48.10044
4  5  5  25  48.74888

ç»Ÿä¸€é‡‡æ · (ç½‘æ ¼ç´¢å¼•):
   x  y   z    target
0  5  5   5  45.56526
1  5  5  10  46.43686
2  5  5  15  48.00318
3  5  5  20  48.10044
4  5  5  25  48.74888

PINN Krigingé£æ ¼ (ç‰©ç†åæ ‡):
          x         y         z      value
0 -1.897810  3.153153 -1.458333  345.70580
1  0.291971 -0.900901 -3.541667  350.60270
2  3.941606 -2.702703 -3.541667   93.48596
3  1.021898 -2.702703 -2.847222  154.13970
4 -7.737226  3.153153  2.708333  337.22290

================================================================================
                                      æµ‹è¯•å®Œæˆ                                      
================================================================================
```

### 6.4 æµ‹è¯•ç»“æœåˆ†æ

#### âœ… æˆåŠŸçš„æ–¹é¢
- **é‡‡æ ·ç‚¹æ•°é‡å®Œå…¨ä¸€è‡´**: ä¸‰ç§æ–¹æ³•éƒ½äº§ç”Ÿäº† 4693 ä¸ªé‡‡æ ·ç‚¹
- **åæ ‡èŒƒå›´ä¸€è‡´**: KrigingåŸç”Ÿå’Œç»Ÿä¸€é‡‡æ ·æ¨¡å—çš„åæ ‡èŒƒå›´å®Œå…¨ç›¸åŒ
- **é‡‡æ ·é€»è¾‘æ­£ç¡®**: æ‰€æœ‰æ–¹æ³•éƒ½èƒ½æ­£ç¡®æ‰§è¡Œï¼Œäº§ç”Ÿåˆç†çš„ç»“æœ

#### âš ï¸ å·²çŸ¥é—®é¢˜
- **å€¼å­˜åœ¨å¾®å°å·®å¼‚**: KrigingåŸç”Ÿå’Œç»Ÿä¸€é‡‡æ ·åœ¨æå°‘æ•°ç‚¹ä¸Šæœ‰å¾®å°æ•°å€¼å·®å¼‚ï¼ˆ~1e-5çº§åˆ«ï¼‰
- **PINNåæ ‡è½¬æ¢**: PINN Krigingé£æ ¼é‡‡æ ·è¾“å‡ºç‰©ç†åæ ‡ï¼Œéœ€è¦åæ ‡è½¬æ¢æ‰èƒ½ä¸ç½‘æ ¼ç´¢å¼•å¯¹æ¯”

#### ğŸ“Š æ€§èƒ½è¡¨ç°
- é‡‡æ ·é€Ÿåº¦å¿«ï¼ˆ<1ç§’ï¼‰
- å†…å­˜ä½¿ç”¨åˆç†
- ç»“æœç¨³å®šå¯é‡ç°

### 6.5 ä½¿ç”¨ç›¸åŒé‡‡æ ·ç‚¹è¿›è¡Œç®—æ³•å¯¹æ¯”

åŸºäºç»Ÿä¸€çš„é‡‡æ ·æ–¹å¼ï¼Œå¯ä»¥ç¡®ä¿PINNå’ŒKrigingä½¿ç”¨å®Œå…¨ç›¸åŒçš„è®­ç»ƒæ•°æ®è¿›è¡Œå…¬å¹³å¯¹æ¯”ï¼š

```python
import numpy as np
from pathlib import Path
import sys

# è®¾ç½®è·¯å¾„
project_root = Path('.').parent
sys.path.insert(0, str(project_root))
sys.path.insert(0, str(project_root / 'ComposeProject' / 'src'))

# ä½¿ç”¨ç»Ÿä¸€çš„Krigingé£æ ¼é‡‡æ ·
from data.loader import sample_kriging_style

# 1. åŠ è½½æ•°æ®ï¼ˆä¸æµ‹è¯•è„šæœ¬ç›¸åŒï¼‰
# ...æ•°æ®åŠ è½½ä»£ç ...

# 2. ä½¿ç”¨ç»Ÿä¸€çš„é‡‡æ ·æ–¹å¼é‡‡æ ·è®­ç»ƒç‚¹
np.random.seed(42)  # ç¡®ä¿å¯é‡ç°
train_points, train_values = sample_kriging_style(
    dose_data,
    box_origin=[5, 5, 5],
    box_extent=[90, 90, 60],
    step_sizes=[5],
    source_positions=[],  # å¯æ ¹æ®éœ€è¦æ·»åŠ æºç‚¹æ’é™¤
    source_exclusion_radius=30.0
)

print(f"ç»Ÿä¸€é‡‡æ ·å®Œæˆ: {len(train_points)} ä¸ªè®­ç»ƒç‚¹")

# 3. PINNè®­ç»ƒ
from pinn_core import PINNTrainer
trainer = PINNTrainer({'rho_material': 1.205, 'mass_energy_abs_coeff': 1.0})
trainer.create_pinn_model(dose_data, train_points, 
                         np.log(train_values + 1e-10).flatten())
trainer.train(epochs=3000, loss_weights=[1, 100])
pinn_pred = trainer.predict(train_points)

# 4. Krigingè®­ç»ƒ
from myKriging import training, testing
import pandas as pd

train_df = pd.DataFrame({
    'x': train_points[:, 0], 'y': train_points[:, 1], 'z': train_points[:, 2],
    'target': train_values.flatten()
})
kriging_model = training(train_df, variogram_model="exponential")
kriging_pred, _ = testing(train_df, kriging_model, compute_precision=False)

# 5. å…¬å¹³å¯¹æ¯”
pinn_mre = np.mean(np.abs(pinn_pred - train_values.flatten()) / (train_values.flatten() + 1e-10))
kriging_mre = np.mean(np.abs(kriging_pred - train_values.flatten()) / (train_values.flatten() + 1e-10))

print(f"PINN MRE (è®­ç»ƒé›†): {pinn_mre:.6f}")
print(f"Kriging MRE (è®­ç»ƒé›†): {kriging_mre:.6f}")
print(f"ä½¿ç”¨ç›¸åŒçš„ {len(train_points)} ä¸ªè®­ç»ƒç‚¹è¿›è¡Œå…¬å¹³å¯¹æ¯”")
```

---

## ä¸ƒã€å¸¸ç”¨æµ‹è¯•åœºæ™¯

### 7.1 æ€§èƒ½åŸºå‡†æµ‹è¯•

```python
import time

# PINNæ€§èƒ½
start = time.time()
trainer.train(epochs=5000)
pinn_time = time.time() - start

# Krigingæ€§èƒ½
start = time.time()
model = training(train_df)
predictions, _ = testing(test_df, model)
kriging_time = time.time() - start

print(f"PINNè€—æ—¶: {pinn_time:.2f}s")
print(f"Krigingè€—æ—¶: {kriging_time:.2f}s")
```

### 7.2 ä¸åŒæ ·æœ¬é‡æµ‹è¯•

```python
sample_sizes = [50, 100, 200, 300, 500]
results = {}

for n in sample_sizes:
    # ä½¿ç”¨ä¸åŒçš„é‡‡æ ·å‚æ•°è·å¾—ä¸åŒæ•°é‡çš„ç‚¹
    train_points, train_values = sample_kriging_style(
        dose_data, box_extent=[min(90, n*2), min(90, n*2), min(60, n)]
    )
    # åˆ†åˆ«è®­ç»ƒå’Œè¯„ä¼°...
    results[n] = {'pinn_mre': ..., 'kriging_mre': ...}
```

### 7.3 ä¸åŒé‡‡æ ·ç­–ç•¥æµ‹è¯•

```python
strategies = ['kriging_style', 'positive_only', 'high_dose']
results = {}

for strategy in strategies:
    if strategy == 'kriging_style':
        train_points, train_values = sample_kriging_style(dose_data)
    else:
        train_points, train_values, _ = DataLoader.sample_training_points(
            dose_data, num_samples=300, sampling_strategy=strategy
        )
    # åˆ†åˆ«è®­ç»ƒå’Œè¯„ä¼°...
    results[strategy] = {'pinn_mre': ..., 'kriging_mre': ...}
```

---

## å…«ã€å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•ç¡®ä¿é‡‡æ ·ç‚¹å®Œå…¨ä¸€è‡´ï¼Ÿ

1. **Krigingé£æ ¼é‡‡æ ·**: ç¡®å®šæ€§é‡‡æ ·ï¼Œç›¸åŒå‚æ•°=ç›¸åŒç»“æœ
2. **éšæœºé‡‡æ ·**: åœ¨é‡‡æ ·å‰è°ƒç”¨ `np.random.seed(42)`
3. **éªŒè¯ä¸€è‡´æ€§**: ä½¿ç”¨ `compare_sampling_methods.py` éªŒè¯

### Q2: GPUå†…å­˜ä¸è¶³ï¼Ÿ

å¯¹äºKrigingï¼Œå‡å° `block_size`ï¼š
```python
testing(df, model, block_size=5000)
```

å¯¹äºPINNï¼Œå‡å° `num_collocation_points`ï¼š
```python
config["pinn"]["model_params"]["num_collocation_points"] = 1024
```

### Q3: å¦‚ä½•åªæµ‹è¯•éƒ¨åˆ†åŒºåŸŸï¼Ÿ

```python
# Krigingé£æ ¼é‡‡æ ·ï¼šè°ƒæ•´box_originå’Œbox_extent
train_points, train_values = sample_kriging_style(
    dose_data,
    box_origin=[10, 10, 10],    # ä»(10,10,10)å¼€å§‹
    box_extent=[50, 50, 30]     # é‡‡æ ·50Ã—50Ã—30çš„åŒºåŸŸ
)

# éšæœºé‡‡æ ·ï¼šäº‹åç­›é€‰
mask = (train_points[:, 0] > 5) & (train_points[:, 0] < 15)
subset_points = train_points[mask]
subset_values = train_values[mask]
```

### Q4: é‡‡æ ·ç»“æœä¸ºä»€ä¹ˆä¼šæœ‰å¾®å°å·®å¼‚ï¼Ÿ

è¿™æ˜¯ç”±äºæ•°æ®è®¿é—®æ–¹å¼çš„ç»†å¾®å·®å¼‚ï¼š
- KrigingåŸç”Ÿ: `data[z][y][x]`
- ç»Ÿä¸€é‡‡æ ·: ç»è¿‡æ•°æ®éªŒè¯çš„è®¿é—®æ–¹å¼

å·®å¼‚åœ¨1e-5çº§åˆ«ä»¥å†…ï¼Œå¯¹å®é™…åº”ç”¨æ— å½±å“ã€‚

---

*æœ€åæ›´æ–°: 2024å¹´*
