# GPU Block-Kriging × PINN 耦合重建工具 - 测试使用说明

## 📋 问题解决总结

### 🔧 已完成的修改

1. **数据源切换**
   - ✅ 将默认数据源从内置随机生成改为真实的 `PINN/DATA.xlsx` 数据
   - ✅ 集成了 `dataAnalysis.get_data()` 函数来正确加载Excel数据
   - ✅ 使用 `tools.py` 中的 `DataLoader.load_dose_from_dict()` 进行数据处理

2. **代码修复**
   - ✅ 修改 `main.py` 中的参数默认值 `--use_real_data` 为 `True`
   - ✅ 添加了异常处理机制，真实数据加载失败时自动回退到合成数据
   - ✅ 优化数据采样策略，使用 `'positive_only'` 策略避免零值问题

3. **测试文件**
   - ✅ 完成了 `test.ipynb` 文件，包含完整的测试流程
   - ✅ 创建了 `test_simple.py` 简化测试脚本
   - ✅ 包含数据加载验证、Kriging基础功能等测试案例

## 🚀 使用方法

### 方法1: 使用主程序（推荐）

```bash
# 激活相应的Python环境
conda activate your_env_name  # 或其他环境激活方式

# 基础功能演示（使用真实数据）
python main.py --mode common

# 方案1: PINN → 残差Kriging → 加权融合
python main.py --mode mode1 --fusion_weight 0.7 --pinn_epochs 1000

# 方案2: Kriging ROI样本扩充 → PINN重训练  
python main.py --mode mode2 --augment_factor 2.0 --roi_strategy high_density

# 使用更小的参数进行快速测试
python main.py --mode mode1 --num_samples 150 --pinn_epochs 500 --save_plots
```

### 方法2: 使用Jupyter Notebook

```bash
# 启动Jupyter Notebook
jupyter notebook test.ipynb

# 或使用JupyterLab
jupyter lab test.ipynb
```

### 方法3: 运行简单测试

```bash
# 运行基础功能测试
python test_simple.py
```

## 📊 数据流程说明

### 输入数据格式
- **文件**: `PINN/DATA.xlsx`
- **格式**: Excel文件，包含多个工作表（每个z层一个表）
- **内容**: 辐射剂量分布数据

### 数据处理流程
1. `dataAnalysis.get_data()` → 加载Excel数据到字典格式
2. `DataLoader.load_dose_from_dict()` → 转换为标准化3D网格
3. `DataLoader.sample_training_points()` → 采样训练点
4. 物理坐标映射和归一化处理

### 输出结果
- PINN预测结果
- Kriging插值结果  
- 融合后的最终预测
- 误差评估指标
- 可视化图表

## ⚙️ 参数配置说明

### 数据参数
- `--num_samples`: 训练样本数量（默认300，可调整为100-500）
- `--data_file`: 数据文件路径（默认 `../PINN/DATA.xlsx`）

### PINN参数  
- `--pinn_epochs`: PINN训练轮数（默认2000，快速测试可用500-1000）

### Kriging参数
- `--variogram_model`: 变异函数模型（linear/exponential/gaussian）

### 方案1参数
- `--fusion_weight`: 融合权重 ω ∈ (0,1)（默认0.5）

### 方案2参数
- `--roi_strategy`: ROI检测策略（high_density/high_value/bounding_box）
- `--augment_factor`: 样本扩充倍数（默认2.0）

## 🐛 常见问题解决

### 1. 内存不足
```bash
# 减少样本数量
python main.py --mode mode1 --num_samples 100

# 减少PINN训练轮数
python main.py --mode mode1 --pinn_epochs 500
```

### 2. GPU内存不足
```bash
# 禁用GPU加速
python main.py --mode mode1 --no_gpu
```

### 3. 数据加载失败
```bash
# 检查数据文件路径
ls -la ../PINN/DATA.xlsx

# 强制使用合成数据
python main.py --mode mode1 --use_synthetic_data
```

### 4. 依赖包缺失
```bash
# 安装基础依赖
pip install numpy pandas matplotlib scikit-learn

# 安装PINN相关
pip install deepxde torch

# 安装GPU加速（可选）
pip install cupy-cuda11x  # 根据CUDA版本选择
```

## 📈 性能优化建议

### 快速测试配置
```bash
python main.py --mode mode1 \
  --num_samples 100 \
  --pinn_epochs 500 \
  --fusion_weight 0.6 \
  --save_plots
```

### 高精度配置
```bash
python main.py --mode mode1 \
  --num_samples 500 \
  --pinn_epochs 3000 \
  --fusion_weight 0.7 \
  --variogram_model gaussian \
  --save_plots
```

### 大数据集配置
```bash
python main.py --mode mode2 \
  --num_samples 200 \
  --pinn_epochs 1500 \
  --augment_factor 1.5 \
  --roi_strategy high_value
```

## 📝 输出文件说明

### 可视化图片（如果使用 `--save_plots`）
- `plots/mode1_pinn_baseline.png`: PINN基线结果
- `plots/mode1_fusion_result.png`: 融合后结果
- `plots/mode1_residual_analysis.png`: 残差分析

### 控制台输出
- 数据加载统计信息
- 训练过程指标
- 预测精度评估
- 性能提升对比

## 🎯 成功验证标志

运行成功时应该看到：
```
✅ 成功加载数据，包含 72 个z层
✅ 数据处理完成
✅ 训练数据采样完成  
✅ PINN训练完成
✅ Kriging插值完成
✅ 融合预测完成
🎉 方案1演示完成!
```

## 🔄 下一步建议

1. **验证数据正确性**: 检查加载的数据范围和分布是否合理
2. **调优参数**: 根据实际需求调整采样点数、训练轮数等
3. **扩展功能**: 基于真实数据结果进一步优化算法
4. **批量测试**: 使用不同参数组合进行多轮测试对比

---

**注意**: 如果遇到环境或依赖问题，请先确保正确安装了所有依赖包，并激活了相应的Python环境。 